<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script
        src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous"></script>




<script>



    var remoteMon = io.connect('http://localhost:60001/remoteMon')


    function dynamicElements() {
        for (let i = 1; i <= 10; i++) {
            $('body').append("<div id = \"div"+i+"\" style=\"position: absolute; border-style: solid; max-width: 150px;\">\n" +
                "    <p id=\"t-slot"+i+"\" > pic "+i+" </p>\n" +
                "        <img id=\"slot"+i+"\"style=\"max-height: 150px; max-width: 150px; min-height: 150px; min-width: 150px\">\n" +
                "\n" +
                "</div>")
        }
    }
    dynamicElements()
    let ElementManager = new Map()
    function addElementVar () {
        for (let i = 1; i <= 10; i++) {
            console.log("adding element variable num " + i)
            ElementManager.set("div"+i, document.getElementById('div'+i))
            ElementManager.set("info"+i, document.getElementById('t-slot'+i))
            ElementManager.set("pic"+i, document.getElementById('slot'+i))
        }
    }
    addElementVar()
    setTimeout(
        ()=>{
            let loc = window.location.href; // or a new URL
            window.location.href = loc + '?n=' + new Date().getTime(); // random number
        },10000
    )
/*
    let div1 = document.getElementById('div1')
    let info1 = document.getElementById('t-slot1')
    let pic1 = document.getElementById("slot1")

    let div2 = document.getElementById('div2')
    let info2 = document.getElementById('t-slot2')
    let pic2 = document.getElementById("slot2")

    let div3 = document.getElementById('div3')
    let info3 = document.getElementById('t-slot3')
    let pic3 = document.getElementById("slot3")

    let div4 = document.getElementById('div4')
    let info4 = document.getElementById('t-slot4')
    let pic4 = document.getElementById("slot4")

    let div5 = document.getElementById('div5')
    let info5 = document.getElementById('t-slot5')
    let pic5 = document.getElementById("slot5")

    let div6 = document.getElementById('div6')
    let info6 = document.getElementById('t-slot6')
    let pic6 = document.getElementById("slot6")

    let div7 = document.getElementById('div7')
    let info7 = document.getElementById('t-slot7')
    let pic7 = document.getElementById("slot7")

    let div8 = document.getElementById('div8')
    let info8 = document.getElementById('t-slot8')
    let pic8 = document.getElementById("slot8")

    let div9 = document.getElementById('div9')
    let info9 = document.getElementById('t-slot9')
    let pic9 = document.getElementById("slot9")

    let div10 = document.getElementById('div10')
    let info10 = document.getElementById('t-slot10')
    let pic10 = document.getElementById("slot10")
    */
    //console.log("show before pic : " + pic)

    let working = false
    remoteMon.on('faces', function (data) {
        if (working === true) {
            console.log("operation abort due to render is not completed")
            return false
        }
        working = true
        document.getElementsByTagName("body")[0].style.display = "none";

        //console.log("get new data")
        let slotrunnumber = 1
        for (let i = 1; i <= 10; i++) {
            cleanelement(eval('div'+i))
        }
        //console.log(data)
        for (let i of data.users) {
            //console.log(i)

            if (i.framebuffer) {
                let img = i.framebuffer
                //console.log('setting picture')
                //onBinaryMessage(img, eval('pic'+slotrunnumber), eval('div'+slotrunnumber),eval('info'+slotrunnumber), i.positionX, i.positionY)
                onBinaryMessage(img, ElementManager.get('pic'+slotrunnumber), ElementManager.get('div'+slotrunnumber), ElementManager.get('info'+slotrunnumber), i.positionX, i.positionY)
            }
            slotrunnumber++

        }
        document.getElementsByTagName("body")[0].style.display = "block";
        working = false
    });



    function onBinaryMessage(input, pic,div,info, posX, posY) {
        //console.log("show after pic : " + pic)

        let blob = new Blob([input], {type: 'image/png'});
        let url = URL.createObjectURL(blob);
        //console.log("url is " + url)
        pic.src = url
        div.style.left = posX*150 + 'px'
        div.style.top = posY*150 + 'px'

        //console.log('render div at left :' + posX*100 + ' at top :' + posY*100)
        blob = null
        url = null
        //pic.src = ""
        /*
        var img = new Image;

        img.onload = function() {
            var ctx = document.getElementById("myCanvas").getContext('2d');
            ctx.drawImage(this, 0, 0);
            URL.revokeObjectURL(url);
        }
        img.src = url;
        */
    }
    function cleanelement (div) {
        div.style.left = -400 + "px"
        div.style.top = -400+ "px"
    }
</script>
</body>
</html>